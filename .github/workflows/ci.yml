name: CI Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  GO_VERSION: '1.24.3'

jobs:
  format-vet-test:
    name: Format, Vet, and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum

      - name: Ensure gofmt produces no diff
        shell: bash
        run: |
          # [IMPL:CI_WORKFLOW] [ARCH:CI_PIPELINE] [REQ:CI_PIPELINE_CORE]
          gofmt -w $(git ls-files '*.go')
          git status --short
          git diff --exit-code

      - name: Run go vet
        shell: bash
        run: |
          # [IMPL:CI_WORKFLOW] [ARCH:CI_PIPELINE] [REQ:CI_PIPELINE_CORE]
          go vet ./...

      - name: Run go test
        shell: bash
        run: |
          # [IMPL:CI_WORKFLOW] [ARCH:CI_PIPELINE] [REQ:CI_PIPELINE_CORE]
          go test ./...

      - name: Validate semantic tokens
        shell: bash
        run: |
          # [IMPL:TOKEN_VALIDATION_SCRIPT] [ARCH:TOKEN_VALIDATION_AUTOMATION] [REQ:STDD_SETUP]
          ./scripts/validate_tokens.sh

  staticcheck:
    name: Staticcheck Analysis
    runs-on: ubuntu-latest
    needs: format-vet-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum

      - name: Install staticcheck
        shell: bash
        run: |
          # [IMPL:STATICCHECK_SETUP] [ARCH:STATIC_ANALYSIS_POLICY] [REQ:STATIC_ANALYSIS]
          go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run staticcheck
        shell: bash
        run: |
          # [IMPL:STATICCHECK_SETUP] [ARCH:STATIC_ANALYSIS_POLICY] [REQ:STATIC_ANALYSIS]
          $(go env GOPATH)/bin/staticcheck ./...

  race-tests:
    name: Race-Enabled Tests
    runs-on: ubuntu-latest
    needs: format-vet-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum

      - name: Run go test -race
        shell: bash
        run: |
          # [IMPL:RACE_JOB] [ARCH:RACE_TESTING_PIPELINE] [REQ:RACE_TESTING]
          go test -race ./...

  release-matrix:
    name: Release Matrix Builds
    runs-on: ubuntu-latest
    needs: format-vet-test
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum

      - name: Build release artifact
        shell: bash
        run: |
          # [IMPL:MAKE_RELEASE_TARGETS] [ARCH:BUILD_MATRIX] [REQ:RELEASE_BUILD_MATRIX]
          make release PLATFORM=${{ matrix.goos }}/${{ matrix.goarch }}

      - name: Show checksum
        shell: bash
        run: |
          # [IMPL:MAKE_RELEASE_TARGETS] [ARCH:BUILD_MATRIX] [REQ:RELEASE_BUILD_MATRIX]
          cat dist/goful_${{ matrix.goos }}_${{ matrix.goarch }}.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goful-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            dist/goful_${{ matrix.goos }}_${{ matrix.goarch }}
            dist/goful_${{ matrix.goos }}_${{ matrix.goarch }}.sha256
